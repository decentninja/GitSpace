using UnityEngine;
using System.Text;
using System.Collections;
using System.Net.Sockets;
using System.IO;
using LitJson;
using System;
using System.Collections.Generic;
using System.Net;
using System.Threading;


public class TCPClient : MonoBehaviour {

    public string ipaddress = "127.0.0.1";
    public int port = 5522;
    public Repositories repos;

    TcpListener server;
    NetworkStream stream;
    Thread thread;

    void Start () {
        //StartCoroutine("TCPClientRoutine");
	ParseJSON(" {'repo': 'PLACEHOLDER', 'type': 'state', 'api version': 1, 'timestamp': 523414140, 'state': [{'subfolder': [{'subfolder': [], 'name': 'Test', 'size': 0, 'filetypes': [{'part': 0, 'extension': 'py'}]}, {'subfolder': [{'subfolder': [], 'name': 'IO', 'size': 8676, 'filetypes': [{'part': 1.0, 'extension': 'py'}]}], 'name': 'src', 'size': 867, 'filetypes': [{'part': 1.0, 'extension': 'py'}]}], 'name': 'Backend', 'size': 0, 'filetypes': []}, {'subfolder': [{'subfolder': [{'subfolder': [], 'name': 'after_prepare', 'size': 2735, 'filetypes': [{'part': 1.0, 'extension': 'js'}]}], 'name': 'hooks', 'size': 3018, 'filetypes': [{'part': 1.0, 'extension': 'md'}]}, {'subfolder': [], 'name': 'resources', 'size': 123067, 'filetypes': [{'part': 1.0, 'extension': 'png'}]}, {'subfolder': [{'subfolder': [], 'name': 'components', 'size': 15, 'filetypes': [{'part': 1.0, 'extension': 'scss'}]}], 'name': 'scss', 'size': 854, 'filetypes': [{'part': 1.0, 'extension': 'scss'}]}, {'subfolder': [{'subfolder': [], 'name': 'css', 'size': 445431, 'filetypes': [{'part': 1.0, 'extension': 'css'}]}, {'subfolder': [], 'name': 'img', 'size': 4757, 'filetypes': [{'part': 1.0, 'extension': 'png'}]}, {'subfolder': [], 'name': 'js', 'size': 1527, 'filetypes': [{'part': 1.0, 'extension': 'js'}]}, {'subfolder': [], 'name': 'views', 'size': 125, 'filetypes': [{'part': 1.0, 'extension': 'html'}]}], 'name': 'www', 'size': 726, 'filetypes': [{'part': 1.0, 'extension': 'html'}]}], 'name': 'ControlPanel', 'size': 8253, 'filetypes': [{'part': 0.05597964376590331, 'extension': ''}, {'part': 0.07657821398279413, 'extension': 'md'}, {'part': 0.09136071731491578, 'extension': 'json'}, {'part': 0.5891191082030777, 'extension': 'xml'}, {'part': 0.16757542711741186, 'extension': 'js'}, {'part': 0.01938688961589725, 'extension': 'project'}]}, {'subfolder': [{'subfolder': [{'subfolder': [{'subfolder': [], 'name': 'ImageEffects', 'size': 69906, 'filetypes': [{'part': 0.9594312362315108, 'extension': 'cs'}, {'part': 0.04056876376848911, 'extension': 'meta'}]}], 'name': 'Editor', 'size': 1550, 'filetypes': [{'part': 0.8793548387096775, 'extension': 'cs'}, {'part': 0.12064516129032259, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Materials', 'size': 10838, 'filetypes': [{'part': 0.0, 'extension': ''}, {'part': 0.9070861782616719, 'extension': 'mat'}, {'part': 0.06643292120317401, 'extension': 'meta'}, {'part': 0.026480900535154086, 'extension': 'physicMaterial'}]}, {'subfolder': [], 'name': 'Prefabs', 'size': 33531, 'filetypes': [{'part': 0.9677909993737138, 'extension': 'prefab'}, {'part': 0.03220900062628612, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [{'subfolder': [], 'name': 'Dosis', 'size': 961714, 'filetypes': [{'part': 0.9920121782567375, 'extension': 'ttf'}, {'part': 0.0032057347610620207, 'extension': 'meta'}, {'part': 0.00478208698220053, 'extension': 'txt'}]}], 'name': 'fonts', 'size': 192, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}], 'name': 'Resources', 'size': 1420338, 'filetypes': [{'part': 0.0009849768153777482, 'extension': 'meta'}, {'part': 0.9990150231846222, 'extension': 'jpg'}]}, {'subfolder': [], 'name': 'Scenes', 'size': 35093, 'filetypes': [{'part': 0.0, 'extension': ''}, {'part': 0.9850397515173966, 'extension': 'unity'}, {'part': 0.014960248482603368, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Scripts', 'size': 75678, 'filetypes': [{'part': 0.0, 'extension': ''}, {'part': 0.2523454636750443, 'extension': 'cs'}, {'part': 0.03051084859536457, 'extension': 'meta'}, {'part': 0.7171436877295911, 'extension': 'dll'}]}, {'subfolder': [{'subfolder': [{'subfolder': [{'subfolder': [], 'name': 'Materials', 'size': 1424, 'filetypes': [{'part': 0.9192415730337079, 'extension': 'mat'}, {'part': 0.08075842696629214, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Shaders', 'size': 2617, 'filetypes': [{'part': 0.949942682460833, 'extension': 'shader'}, {'part': 0.050057317539166986, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Textures', 'size': 1016541, 'filetypes': [{'part': 0.9978446516175934, 'extension': 'tif'}, {'part': 0.002155348382406612, 'extension': 'meta'}]}], 'name': 'GlassRefraction', 'size': 381, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [], 'name': 'Scripts', 'size': 235105, 'filetypes': [{'part': 0.9378107654026924, 'extension': 'cs'}, {'part': 0.06218923459730759, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [], 'name': 'Contrast Stretch', 'size': 5130, 'filetypes': [{'part': 0.9306042884990253, 'extension': 'shader'}, {'part': 0.06939571150097466, 'extension': 'meta'}]}, {'subfolder': [], 'name': '_Antialiasing', 'size': 94640, 'filetypes': [{'part': 0.9934171597633136, 'extension': 'shader'}, {'part': 0.0065828402366863905, 'extension': 'meta'}]}, {'subfolder': [], 'name': '_BloomAndFlares', 'size': 34404, 'filetypes': [{'part': 0.9689570980118591, 'extension': 'shader'}, {'part': 0.031042901988140914, 'extension': 'meta'}]}, {'subfolder': [], 'name': '_DepthOfField', 'size': 57326, 'filetypes': [{'part': 0.9891323308795311, 'extension': 'shader'}, {'part': 0.010867669120468897, 'extension': 'meta'}]}], 'name': 'Shaders', 'size': 118276, 'filetypes': [{'part': 0.8803645710034157, 'extension': 'shader'}, {'part': 0.03076701951367987, 'extension': 'meta'}, {'part': 0.08886840948290439, 'extension': 'cginc'}]}, {'subfolder': [], 'name': 'Textures', 'size': 1172837, 'filetypes': [{'part': 0.1643834565246492, 'extension': 'png'}, {'part': 0.007828879886974916, 'extension': 'meta'}, {'part': 0.8277876635883759, 'extension': 'psd'}]}], 'name': 'ImageEffects', 'size': 381, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [], 'name': 'Textures', 'size': 551027, 'filetypes': [{'part': 0.36259566228152157, 'extension': 'tif'}, {'part': 0.012748921559197643, 'extension': 'meta'}, {'part': 0.6246554161592808, 'extension': 'psd'}]}], 'name': 'LightCookies', 'size': 127, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [], 'name': 'Flares', 'size': 6270, 'filetypes': [{'part': 0.9449760765550239, 'extension': 'flare'}, {'part': 0.05502392344497608, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Materials', 'size': 824, 'filetypes': [{'part': 0.8604368932038835, 'extension': 'mat'}, {'part': 0.1395631067961165, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Textures', 'size': 378300, 'filetypes': [{'part': 0.9941897964578377, 'extension': 'psd'}, {'part': 0.005810203542162305, 'extension': 'meta'}]}], 'name': 'LightFlares', 'size': 381, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [], 'name': 'Materials', 'size': 11170, 'filetypes': [{'part': 0.9691136974037601, 'extension': 'mat'}, {'part': 0.03088630259623993, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Prefabs', 'size': 5709, 'filetypes': [{'part': 0.9395691014188124, 'extension': 'prefab'}, {'part': 0.0604308985811876, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Shaders', 'size': 2816, 'filetypes': [{'part': 0.9069602272727273, 'extension': 'shader'}, {'part': 0.09303977272727272, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Textures', 'size': 318019, 'filetypes': [{'part': 0.9862366713938475, 'extension': 'psd'}, {'part': 0.013763328606152463, 'extension': 'meta'}]}], 'name': 'Projectors', 'size': 1198, 'filetypes': [{'part': 0.48163606010016696, 'extension': 'txt'}, {'part': 0.5183639398998331, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [], 'name': 'Materials', 'size': 4353, 'filetypes': [{'part': 0.9207443142660234, 'extension': 'mat'}, {'part': 0.07925568573397657, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Models', 'size': 20747, 'filetypes': [{'part': 0.9215790234732733, 'extension': 'fbx'}, {'part': 0.07842097652672675, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Scenes', 'size': 22353, 'filetypes': [{'part': 0.9950789603185255, 'extension': 'unity'}, {'part': 0.004921039681474522, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Shaders', 'size': 3331, 'filetypes': [{'part': 0.9213449414590213, 'extension': 'shader'}, {'part': 0.07865505854097868, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Textures', 'size': 728211, 'filetypes': [{'part': 0.9963966487735011, 'extension': 'png'}, {'part': 0.0036033512264989132, 'extension': 'meta'}]}], 'name': 'TessellationShaders', 'size': 635, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [], 'name': 'Materials', 'size': 7082, 'filetypes': [{'part': 0.9350465970064954, 'extension': 'mat'}, {'part': 0.06495340299350466, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Shaders', 'size': 4670, 'filetypes': [{'part': 0.8877944325481799, 'extension': 'shader'}, {'part': 0.11220556745182013, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Textures', 'size': 34899, 'filetypes': [{'part': 0.9313447376715666, 'extension': 'psd'}, {'part': 0.0633542508381329, 'extension': 'meta'}, {'part': 0.005301011490300582, 'extension': 'png'}]}], 'name': 'ToonShading', 'size': 381, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}], 'name': 'Effects', 'size': 889, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}], 'name': 'Standard Assets', 'size': 127, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}, {'subfolder': [{'subfolder': [{'subfolder': [], 'name': 'Object Merge', 'size': 6065, 'filetypes': [{'part': 0.9897774113767519, 'extension': 'unity'}, {'part': 0.010222588623248145, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Prefabs', 'size': 23955, 'filetypes': [{'part': 0.9922354414527239, 'extension': 'prefab'}, {'part': 0.007764558547276142, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Scene Merge', 'size': 16935, 'filetypes': [{'part': 0.9926778860348391, 'extension': 'unity'}, {'part': 0.007322113965160909, 'extension': 'meta'}]}], 'name': 'Demo', 'size': 844, 'filetypes': [{'part': 0.7559241706161137, 'extension': 'meta'}, {'part': 0.24407582938388625, 'extension': 'cs'}]}, {'subfolder': [], 'name': 'Editor', 'size': 139805, 'filetypes': [{'part': 0.9982833232001717, 'extension': 'cs'}, {'part': 0.0017166767998283324, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'Skin', 'size': 99070, 'filetypes': [{'part': 0.2279802160088826, 'extension': 'png'}, {'part': 0.04166750782275159, 'extension': 'meta'}, {'part': 0.7303522761683658, 'extension': 'guiskin'}]}], 'name': 'UniMerge', 'size': 27748, 'filetypes': [{'part': 0.02515496612368459, 'extension': 'meta'}, {'part': 0.10227764163182933, 'extension': 'zip'}, {'part': 0.8725673922444861, 'extension': 'txt'}]}], 'name': 'Assets', 'size': 1536, 'filetypes': [{'part': 1.0, 'extension': 'meta'}]}, {'subfolder': [], 'name': 'ProjectSettings', 'size': 28002, 'filetypes': [{'part': 0.9981429897864438, 'extension': 'asset'}, {'part': 0.0018570102135561746, 'extension': 'txt'}]}], 'name': 'MainScreen', 'size': 370, 'filetypes': [{'part': 1.0, 'extension': ''}]}]} ");
	ParseJSON("{ 'type': 'update', 'repo': 'PLACEHOLDER', 'apiv': 1, 'timestamp': 1230583000, 'direction': 'forward/backward', 'forced': false, 'changes': [{ 'name': 'MainScreen', 'size': -6, 'user': 'powie@powltd.com', 'action': 'delete/update/create', 'non_master_branch': false, 'subfolder': [], 'filetypes': [ { 'extension': 'py', 'part': 0.1 }, { 'extension': 'txt', 'part': -0.1 } ] }] }");
    }

    private void ParseJSON(string json) {
        try {
	    JsonData parsed = JsonMapper.ToObject(json);
	    repos.handle(parsed);
        }
        catch (JsonException e) {
            Debug.LogError("Invalid JSON " + json);
        }
    }

    IEnumerator TCPClientRoutine() {
        TcpClient connection = new TcpClient(ipaddress, port);
        NetworkStream stream = connection.GetStream();
	StringBuilder json = new StringBuilder();
	while(true) {
	    if(stream.DataAvailable) {
		int c = stream.ReadByte();
		if(c == 2)
		    continue;
		if(c == 3) {
		    string done = json.ToString();
		    ParseJSON(done);
		    json.Length = 0;
		    yield return null;
		} else {
		    json.Append((char) c);
		}
	    } else {
		yield return null;
	    }
        }
    }

}
